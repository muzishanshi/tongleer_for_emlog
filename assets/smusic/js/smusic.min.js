/**
 * sMusic
 * Author:Smohan
 * Version: 2.0.0
 * url: http://www.smohan.net/lab/smusic.html
 * 使用请保留以上信息
 */
!function(a){function b(a,b){0==c(a,b)&&(a.className+=" "+b)}function c(a,b){return!!a.className.match(new RegExp("(\\s|^)"+b+"(\\s|$)"))}function d(a,b){var d=a.className;c(a,b)&&(d=d.replace(new RegExp("(\\s|^)"+b+"(\\s|$)")," "),d=d.replace(/(^\s*)|(\s*$)/g,""),a.className=d)}function e(a,e){c(a,e)?d(a,e):b(a,e)}function f(a){return document.querySelector(a)}function g(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function h(a){var b,c,d,e="";return b=String(parseInt(a/3600,10)),c=String(parseInt(a%3600/60,10)),d=String(parseInt(a%60,10)),"0"!=b&&(1==b.length&&(b="0"+b),e+=b+":"),1==c.length&&(c="0"+c),e+=c+":",1==d.length&&(d="0"+d),e+=d}function i(a,b){if(!a)return!1;var c=new XMLHttpRequest;return c.onreadystatechange=function(){if(4==c.readyState){var a=c.status;return a>=200&&300>a||304==a?(b&&"function"==typeof b&&b(c.responseText),!0):new Error("ajax请求失败")}},c.open("GET",a,!0),c.setRequestHeader("X-Requested-With","XMLHttpRequest"),c.send(),!0}function k(a){var b=this.config;this.config=g(b,a),this.musicList=this.config.musicList||[],this.musicLength=this.musicList.length,this.musicLength&&f("body")||(this.musicDom.listWrap.innerHTML="<p>暂无播放记录...</p>"),this.audioDom=null,this.init()}var j=null;k.prototype={config:{musicList:[],defaultVolume:.7,defaultIndex:0,autoPlay:!1,defaultMode:1,callback:function(){}},createListDom:function(){var a=0,b="<ul>";for(a;a<this.musicLength;a++)b+='<li class="f-toe"><strong>'+this.musicList[a]["title"]+"</strong> -- <small>"+this.musicList[a]["singer"]+"</small></li>";b+="</ul>",this.musicDom.listWrap.innerHTML=b},setBuffer:function(a,b){var c=b.parentNode.offsetWidth;j=setInterval(function(){var e,d=a.buffered.length;d>0&&void 0!=a.buffered&&(e=a.buffered.end(d-1)/a.duration*c,b.style.width=e+"px",Math.abs(a.duration-a.buffered.end(d-1))<1&&(b.style.width=c+"px",clearInterval(j)))},1e3)},resetPlayer:function(a){var c,e,f,g,h,i;for(a>=this.musicLength-1&&(a=this.musicLength-1),0>=a&&(a=0),this.currentMusic=a,c=this.musicList[a],e=this,f=function(){return e.setBuffer(this,e.musicDom.bufferProcess)},this.audioDom.removeEventListener("canplay",f,!1),clearInterval(j),this.musicDom.bufferProcess.style.width="0px",this.musicDom.curProcess.style.width="0px",this.audioDom.src=c.src,this.musicDom.cover.innerHTML='<img src="'+c.cover+'" title="'+c.title+" -- "+c.singer+'">',this.musicDom.title.innerHTML="<strong>"+c.title+"</strong><small>"+c.singer+"</small>",e.musicDom["lyricWrap"].innerHTML='<li class="eof">正在加载歌词...</li>',e.musicDom["lyricWrap"].style.marginTop="0px",e.musicDom["lyricWrap"].scrollTop=0,this.getLyric(a),g=document.querySelectorAll(".m-music-list-wrap li"),h=0,h;h<this.musicLength;h++)h==a?b(g[h],"current"):d(g[h],"current");this.audioDom.addEventListener("canplay",f,!1),this.config.autoPlay?this.play():this.pause(),i=c,i.index=a,"function"==typeof this.config.callback&&this.config.callback(i)},setVolume:function(a){var f,c=this.musicDom.volume,e=c.volumeEventer.offsetHeight||50;0>=a&&(a=0),a>=1&&(a=1),this.audioDom.volume=a,f=e*a,c.volumeCurrent.style.height=f+"px",c.volumeCtrlBar.style.bottom=f+"px",c.volumeProcess.setAttribute("data-volume",a),0==a?(b(c.volumeControl,"muted"),this.audioDom.muted=!0):(d(c.volumeControl,"muted"),this.audioDom.muted=!1)},initPlay:function(){var a=this.config.defaultIndex;2==this.playMode&&(a=this.getRandomIndex()),this.setVolume(this.config.defaultVolume),this.audioDom.load(),this.resetPlayer(a)},play:function(){var a=this.musicDom.button.ctrl;this.audioDom.play(),d(a,"paused"),b(a,"play"),a.setAttribute("title","暂停"),d(this.musicDom.cover,"paused"),b(this.musicDom.cover,"play")},pause:function(){var a=this.musicDom.button.ctrl;this.audioDom.pause(),d(a,"play"),b(a,"paused"),a.setAttribute("title","播放"),d(this.musicDom.cover,"play"),b(this.musicDom.cover,"paused")},getRandomIndex:function(){var e,a=this.currentMusic,b=this.musicLength,c=0,d=[];for(c;b>c;c++)c!=a&&d.push(c);return e=parseInt(Math.random()*d.length),d[e]},playByMode:function(a){var b=this.playMode,c=this.currentMusic,d=this.musicLength,e=c;1==b?"prev"==a?e=d-1>=c&&c>0?c-1:d-1:("next"==a||"ended"==a)&&(e=c>=d-1?0:c+1):2==b?e=this.getRandomIndex():3==b&&(e="prev"==a?d-1>=c&&c>0?c-1:d-1:"next"==a?c>=d-1?0:c+1:c),this.resetPlayer(e)},action:function(){var j,k,l,a=this,g=this.musicDom.volume,i=this.musicDom.button;for(this.audioDom.addEventListener("timeupdate",function(){var e,f,g,i,j,k,l,m,n,o,p,c=this;if(!isNaN(c.duration)&&(e=h(c.currentTime),f=h(c.duration),g=c.currentTime/c.duration*a.musicDom.bufferProcess.parentNode.offsetWidth,a.musicDom.time.innerHTML=""+e+"/"+f,a.musicDom.curProcess.style.width=g+"px",i=parseInt(1e3*c.currentTime),j=a.musicDom["lyricWrap"].querySelectorAll(".u-lyric"),k=j.length,l=0,k>1))for(;k>l;l++)if(m=j[l],m&&(n=parseFloat(m.getAttribute("data-time")),i>=n)){for(o=30*(l-1),a.musicDom["lyricWrap"].style.marginTop=-o+"px",p=0;k>p;p++)j[p]&&d(j[p],"current");b(m,"current")}},!1),this.audioDom.addEventListener("ended",function(){a.playByMode("ended")},!1),g.volumeControl.addEventListener("click",function(d){d=d||window.event,d.stopPropagation(),c(g.volumeProcess,"show")?(e(this,"muted"),a.audioDom.muted=c(this,"muted")?!0:!1):b(g.volumeProcess,"show")},!1),document.addEventListener("click",function(a){a=a||window.event,a.stopPropagation();var b=a.target||a.srcElement;b.parentNode!==g.volumeProcess&&b.parentNode!==f(".grid-music-container .u-volume")&&d(g.volumeProcess,"show")},!1),g.volumeEventer.addEventListener("click",function(b){b=b||window.event,b.stopPropagation();var c=this.offsetHeight,d=b.offsetY,e=(c-d)/c;a.setVolume(e)},!1),j=document.querySelectorAll(".m-music-list-wrap li"),k=0,k;k<this.musicLength;k++)!function(b){j[b].addEventListener("click",function(){a.resetPlayer(b)},!1)}(k);i.ctrl.addEventListener("click",function(){c(this,"play")?a.pause():a.play()},!1),i.prev.addEventListener("click",function(){a.playByMode("prev")},!1),i.next.addEventListener("click",function(){a.playByMode("next")},!1),i.listCircular.addEventListener("click",function(){b(this,"current"),d(i.singleCircular,"current"),d(i.randomPlay,"current"),a.playMode=1}),i.randomPlay.addEventListener("click",function(){b(this,"current"),d(i.singleCircular,"current"),d(i.listCircular,"current"),a.playMode=2}),i.singleCircular.addEventListener("click",function(){b(this,"current"),d(i.listCircular,"current"),d(i.randomPlay,"current"),a.playMode=3}),l=this.musicDom["curProcess"].parentNode,l.addEventListener("click",function(b){var c,d,e;b=b||window.event,c=this.getBoundingClientRect().left,d=this.offsetWidth,e=Math.min(d,Math.abs(b.clientX-c)),a.audioDom.currentTime&&a.audioDom.duration&&(a.audioDom.currentTime=parseInt(e/d*a.audioDom.duration),a.play())})},getLyric:function(a){if(this.lyricCache[a])this.renderLyric(this.lyricCache[a]);else{var b=this.musicList[a]["lyric"],c=this;b?i(b,function(b){c.lyricCache[a]=b?b:null,c.renderLyric(b)}):(this.lyricCache[a]=null,c.renderLyric(null))}},parseLyric:function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;if(!a)return a;for(b=[],c=a.split("["),c.shift(),d=0;d<c.length;d++)if(e=c[d].split("]"),e.length>=2&&""!=e[1]){if(f=e[0].split(":"),g=0,f.length>=2){for(h=f[0].split(""),i=0,j=0;j<h.length;j++)Number(h[j])>0&&(i+=h[j]*Math.pow(10,h.length-j-1));for(g+=60*i,k=f[1].split("."),l=k[0].split(""),m=0,n=0;n<l.length;n++)Number(l[n])>0&&(m+=l[n]*Math.pow(10,l.length-n-1));g+=Number(m+"."+k[1])}g&&"number"==typeof g&&b.push({time:parseInt(1e3*g),content:e[1]})}return b},renderLyric:function(a){var e,b,c,d,f,g,h,i;if(a=this.parseLyric(a),b=this,c=b.musicDom["lyricWrap"],d="",f=0,e=a?a.length:0,a&&e){for(f;e>f;f++)g=a[f],h=g["time"],i=g["content"].trim(),i=i?i:"--- smusic ---",d+='<li class="u-lyric f-toe" data-time="'+h+'">'+i+"</li>";d&&(d+='<li class="u-lyric">www.smohan.net</li>')}else d='<li class="eof">暂无歌词...</li>';c.style.marginTop="0px",c.screenTop=0,c.innerHTML=d},init:function(){this.musicDom={music:f(".grid-music-container"),cover:f(".grid-music-container .u-cover"),title:f(".grid-music-container .u-music-title"),curProcess:f(".grid-music-container .current-process"),bufferProcess:f(".grid-music-container .buffer-process"),time:f(".grid-music-container .u-time"),listWrap:f(".grid-music-container .m-music-list-wrap"),lyricWrap:f(".grid-music-container .js-music-lyric-content"),volume:{volumeProcess:f(".grid-music-container .volume-process"),volumeCurrent:f(".grid-music-container .volume-current"),volumeCtrlBar:f(".grid-music-container .volume-bar"),volumeEventer:f(".grid-music-container .volume-event"),volumeControl:f(".grid-music-container .volume-control")},button:{ctrl:f(".grid-music-container .ctrl-play"),prev:f(".grid-music-container .prev"),next:f(".grid-music-container .next"),listCircular:f(".grid-music-container .mode-list"),randomPlay:f(".grid-music-container .mode-random"),singleCircular:f(".grid-music-container .mode-single")}},this.currentMusic=this.config.defaultIndex||0,this.playMode=this.config.defaultMode||1,this.lyricCache={},this.audioDom=document.createElement("audio"),this.createListDom(),this.initPlay(),this.action()}},a=a||window,a.SMusic=function(a){return new k(a)}}(window);